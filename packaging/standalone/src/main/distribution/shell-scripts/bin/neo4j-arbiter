#!/bin/bash
# Copyright (c) 2002-2015 "Neo Technology,"
# Network Engine for Objects in Lund AB [http://neotechnology.com]
#
# This file is part of Neo4j.
#
# Neo4j is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.

set -euo pipefail

FRIENDLY_NAME="Neo4j Arbiter"

function findBaseDirAndCdThere {
# This seems to not be safe to run at any time. If that
# is the case, it should be fixed to be so, if possible.
  SCRIPT=$0

  cd "$(dirname "${SCRIPT}")"
  SCRIPT="$(basename "${SCRIPT}")"

  while [ -L "${SCRIPT}" ]
  do
    SCRIPT="$(readlink "${SCRIPT}")"
    cd "$(dirname "${SCRIPT}")"
    SCRIPT="$(basename "${SCRIPT}")"
  done
  NEO4J_HOME="$(cd "$(dirname "${SCRIPT}")/.." && dirs -l +0)"
  [[ "${NEO4J_CONFIG:-}" ]] || NEO4J_CONFIG="${NEO4J_HOME}/conf"
  [[ "${NEO4J_LOG:-}" ]] || NEO4J_LOG="${NEO4J_HOME}/data/log"
  [[ "${NEO4J_PIDFILE:-}" ]] || NEO4J_PIDFILE="${NEO4J_HOME}/data/neo4j-service.pid"

  cd "${NEO4J_HOME}"
}

function parseConfig {
  getconfig "${NEO4J_CONFIG}/arbiter-wrapper.conf"
}

findBaseDirAndCdThere
source bin/utils
parseConfig

JAVA_OPTS="-server"
[[ "${wrapper_java_additional:-}" ]] && JAVA_OPTS="${JAVA_OPTS} ${wrapper_java_additional}"
[[ "${wrapper_java_initmemory:-}" ]] && JAVA_OPTS="${JAVA_OPTS} -Xms${wrapper_java_initmemory}m"
[[ "${wrapper_java_maxmemory:-}" ]] && JAVA_OPTS="${JAVA_OPTS} -Xmx${wrapper_java_maxmemory}m"

TIMEOUT=20
PID_FILE=${NEO4J_PIDFILE}

buildclasspath() {
  CLASSPATH="${NEO4J_HOME}/lib/*:${NEO4J_HOME}/system/lib/*"
}

startit() {
  checkstatus
  if [[ "${NEO4J_PID:-}" ]] ; then
    echo "${FRIENDLY_NAME} is already running (pid ${NEO4J_PID})."
    exit 0
  fi

  exitonnojava
  checkjvmcompatibility

  echo "Starting ${FRIENDLY_NAME}."

  buildclasspath
  checkandrepairenv

  CONSOLE_LOG="${NEO4J_LOG}/arbiter-console.log"
  nohup "${JAVACMD}" -cp "${CLASSPATH}" ${JAVA_OPTS} -Dneo4j.home="${NEO4J_HOME}" -Dfile.encoding=UTF-8 \
    org.neo4j.server.enterprise.StandaloneClusterClient \
    >>"${CONSOLE_LOG}" 2>&1 &
  echo "$!" >"${PID_FILE}"

  sleep "${NEO4J_START_WAIT:-5}"
  checkstatus
  if [[ ! "${NEO4J_PID:-}" ]] ; then
    echo "Unable to start. See ${CONSOLE_LOG} for details."
    rm "${PID_FILE}"
    exit 1
  fi

  echo "Started."
  echo "This instance is now joining the cluster. See ${CONSOLE_LOG} for current status."
}

console() {
  checkstatus
  if [[ "${NEO4J_PID:-}" ]] ; then
    echo "${FRIENDLY_NAME} is already running (pid ${NEO4J_PID})."
    exit 1
  fi

  exitonnojava
  checkjvmcompatibility

  echo "Starting ${FRIENDLY_NAME}."

  buildclasspath
  checkandrepairenv

  exec "${JAVACMD}" -cp "${CLASSPATH}" ${JAVA_OPTS} -Dneo4j.home="${NEO4J_HOME}" -Dfile.encoding=UTF-8 \
    org.neo4j.server.enterprise.StandaloneClusterClient
}

showinfo() {
  reportstatus

  exitonnojava
  buildclasspath

  echo "NEO4J_HOME:        ${NEO4J_HOME}"
  echo "JAVA_HOME:         ${JAVA_HOME}"
  echo "JAVA_OPTS:         ${JAVA_OPTS}"
  echo "CLASSPATH:         ${CLASSPATH}"
}

case "${1}" in
  console)
    console
    ;;

  start)
    startit
    ;;

  stop)
    stopit
    ;;

  restart)
    stopit
    startit
    ;;

  status)
    reportstatus
    ;;

  info)
    showinfo
    ;;

  *)
    echo "Usage: neo4j { start | stop | restart | status | info }"
    ;;
esac

exit $?
